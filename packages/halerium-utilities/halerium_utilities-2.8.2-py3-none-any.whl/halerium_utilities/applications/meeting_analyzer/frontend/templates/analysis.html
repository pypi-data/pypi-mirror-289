<!DOCTYPE html>
<html lang="en">

<head>

    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="" />
        <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
        <link rel="shortcut icon" href="{{ url_for('static', path='/img/hal.png')}}" />
        <link href="{{ url_for('static', path='/style/main.css') }}" rel="stylesheet" />
        <link href="{{ url_for('static', path='/style/meeting.css') }}" rel="stylesheet" />
        <link href="{{ url_for('static', path='/style/dropdownComponent.css') }}" rel="stylesheet" />
        <title>Halerium Meetings</title>

    </head>
</head>

<body>
    <div class="flex col fw fh xc yc">
        <div class="flex container col fw" style="justify-content: space-between;">
            <div class="flex row logoContainer" style="justify-content: space-between;">
                <div class="flex col">
                    <div class="logo"></div>
                    <div class="subheader">Intelligent Meeting Minutes</div>
                </div>
                <div class="flex row">
                    <a href="{{ url_for('index') }}" class="btnNavigator">Start Over</a>
                    <a href="{{ chatbot_link }}" target="_blank" class="btnNavigator">Go to Chatbot</a>
                </div>
            </div>
            <h1>Transcript Analysis</h1>
            <div id="state"></div>
            <form id="approveForm">
                {% for key, value in analysis_output.items() %}
                <div class="flex col fw analysisItem" style="margin-top:16px;">
                    <label for="{{ key }}">{{ key }}</label>
                    <textarea class="taUserInput" id="{{ key }}" name="{{ key }}">{{ value }}</textarea>
                </div>
                {% endfor %}
                <div class="flex row-hard fw" style="justify-content: space-between;">
                    <button type="submit" id="approveAndProcessBtn" class="btnPrimary" style="width:45%;">Approve and
                        Process</button>
                    <a href="{{ deep_link }}" target="_blank" class="btnPrimary" style="width:45%;">Modify on Board</a>

                </div>
            </form>
        </div>
    </div>
    <script>
        const textareas = document.querySelectorAll('textarea');
        textareas.forEach(ta => {
            function resizeTextarea() {
                ta.style.height = 'auto'; // Reset the height
                requestAnimationFrame(() => {
                    ta.style.height = ta.scrollHeight + 'px';
                });
            }

            resizeTextarea();

            ta.addEventListener('input', resizeTextarea);
        });

        document.getElementById('approveForm').addEventListener('submit', async (event) => {
            event.preventDefault();
            document.getElementById('approveAndProcessBtn').classList.add("disabled");

            const data = { "approved": {} };

            {% for key, value in analysis_output.items() %}
            data["approved"]['{{ key }}'] = document.getElementById('{{ key }}').value;
            {% endfor %}

            data['board_path'] = "{{ meeting_board_path }}";
            data['transcript'] = `{{ transcript | tojson | safe }}`;

            const response = await fetch("{{ url_for('approve_and_postprocess') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            });

            if (response.ok) {
                const result = await response.json();
                textareas.forEach(ta => {
                    ta.style.height = 'auto'; // Reset the height
                    ta.style.height = ta.scrollHeight + 'px';
                });

                // load the success page
                window.location.href = "{{ url_for('success') }}?deep_link={{ deep_link }}&success=true";

            } else {
                console.error('Failed to send data');
                window.location.href = "{{ url_for('success') }}?deep_link={{ deep_link }}&success=false";
            }
        });
    </script>
</body>

</html>