- hosts:
    - master[0]
    - other_build_image
  name: build image for npu-exporter
  tasks:
    - name: build npu-exporter image
      install_npu_exporter:
        resources_dir: "{{ resource_path }}"
        harbor_server: "{{ HARBOR_SERVER }}"
        step: 'build'

    - name: fetch npu-exporter image
      scp:
        ip: "{{ inventory_hostname }}"
        remote_user: "{{ ansible_ssh_user }}"
        passwd: "{{ ansible_ssh_pass|default('') }}"
        src: "{{ npu_exporter_images }}"
        dest: "{{ resource_path }}/mindxdl/dlImages/{{ ansible_architecture }}/npu-exporter"
        fetch: 'true'
      delegate_to: localhost

- hosts:
    - localhost
  name: push npu-exporter image to harbor
  tasks:
    - name: push to harbor
      push_image:
        harbor_server: "{{ HARBOR_SERVER }}"
        project_name: "mindx"
        public: "{{ HARBOR_PUBLIC_PROJECT }}"
        user: "{{ HARBOR_ADMIN_USER }}"
        password: "{{ HARBOR_ADMIN_PASSWORD }}"
        image_dir: "{{ resource_path }}/mindxdl/dlImages/"
        component_name: "npu-exporter"
      when: use_harbor

- hosts:
    - worker
  name: install or upgrade npu-exporter
  tasks:
    - name: push images to remote
      scp:
        ip: "{{ inventory_hostname }}"
        remote_user: "{{ ansible_ssh_user }}"
        passwd: "{{ ansible_ssh_pass|default('') }}"
        src: "{{ resource_path }}/mindxdl/dlImages/{{ ansible_architecture }}/npu-exporter/*"
        dest: "{{ resource_path }}/mindxdl/dlImages/{{ ansible_architecture }}/npu-exporter/"
      delegate_to: localhost
      when: not use_harbor

    - name: install npu-exporter
      install_npu_exporter:
        resources_dir: "{{ resource_path }}"
        harbor_server: "{{ HARBOR_SERVER }}"
        step: 'install'

    - name: apply npu-exporter
      throttle: 1
      install_npu_exporter:
        resources_dir: "{{ resource_path }}"
        harbor_server: "{{ HARBOR_SERVER }}"
        step: 'apply'
        node_name: "{{ NODE_NAME }}"
        master_node: "{{ inventory_hostname in groups['master'] }}"
        worker_node: "{{ inventory_hostname in groups['worker'] }}"
        labels: "{{ npu_exporter_labels }}"
      delegate_to: "{{ groups['master'][0] }}"
