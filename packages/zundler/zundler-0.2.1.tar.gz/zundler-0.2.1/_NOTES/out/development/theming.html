<!DOCTYPE html>
<html lang="en">
<head><script>/*
 * Monkeypatch URLSearchParams
 *
 * Sphinx documents that use `searchtool.js` rely on passing information via
 * GET parameters (aka search parameters). Unfortunately, this doesn't work
 * in our approach due to the same origin policy, so we have to get ...
 * creative.
 *
 * Here, we patch the `URLSearchParams` class so it returns the information
 * stored in `window.global_context.get_parameters`.
 *
 */

const originalGet = URLSearchParams.prototype.get;

var myGet = function (arg) {
    const originalResult = originalGet.apply(this, [arg]);
    // If searchtools.js of sphinx is used
    if (
        window.global_context.get_parameters &&
        (window.location.search === "") &&
        (Array.from(this.entries()).length == 0)
    ) {
        const params = new URLSearchParams('?' + window.global_context.get_parameters);
        const result = params.get(arg);
        // console.log("Return virtual get parameter:", arg, result);
        return result;
    } else {
        return originalResult;
    }
};

URLSearchParams.prototype.get = myGet;

/*
 * Monkeypatch fetch
 */

const { fetch: originalFetch } = window;

window.fetch = async (...args) => {
    let [resource, config ] = args;
    var path = normalize_path(resource);
    var response;
    if (is_virtual(path)) {
        var data = retrieve_file(path);
        response = new Response(data);

    } else {
        response = await originalFetch(resource, config);
    }
    return response;
};
//# sourceURL=inject_pre.js</script>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/><meta content="Docutils 0.17.1: http://docutils.sourceforge.net/" name="generator"/>
<title>HTML theme development — Sphinx documentation</title>
<link href="../_static/pygments.css" rel="stylesheet" type="text/css"/>
<link href="../_static/basic.css" rel="stylesheet" type="text/css"/>
<link href="../_static/graphviz.css" rel="stylesheet" type="text/css"/>
<link href="../_static/sphinx13.css" rel="stylesheet" type="text/css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.13.1/underscore-min.js"></script>
<script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
<script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
<script src="../_static/jquery.js"></script>
<script src="../_static/underscore.js"></script>
<script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
<script src="../_static/doctools.js"></script>
<script src="../_static/sphinx_highlight.js"></script>
<link href="https://www.sphinx-doc.org/en/master/development/theming.html" rel="canonical"/>
<link href="../_static/opensearch.xml" rel="search" title="Search within Sphinx documentation" type="application/opensearchdescription+xml"/>
<link href="../_static/favicon.svg" rel="shortcut icon"/>
<link href="../genindex.html" rel="index" title="Index"/>
<link href="../search.html" rel="search" title="Search"/>
<link href="../templating.html" rel="next" title="Templating"/>
<link href="builders.html" rel="prev" title="Configuring builders"/>
</head><body>
<div class="pageheader">
<a href="../index.html">
<img alt="SPHINX" src="../_static/sphinxheader.png"/>
</a>
</div>
<div aria-label="related navigation" class="related" role="navigation">
<h3>Navigation</h3>
<ul>
<li><a href="../index.html">Documentation</a> »</li>
<li class="nav-item nav-item-1"><a accesskey="U" href="index.html">Extending Sphinx</a> »</li>
<li class="nav-item nav-item-this"><a href="">HTML theme development</a></li>
</ul>
</div>
<div class="document">
<div aria-label="main navigation" class="sphinxsidebar" role="navigation">
<div id="searchbox" role="search" style="display: none">
<h3 id="searchlabel">Quick search</h3>
<div class="searchformwrapper">
<form action="../search.html" class="search" method="get">
<input aria-labelledby="searchlabel" autocapitalize="off" autocomplete="off" autocorrect="off" name="q" spellcheck="false" type="text"/>
<input type="submit" value="Go"/>
</form>
</div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
<div class="sphinxsidebar-navigation__contents">
<h3>On this page</h3>
<ul>
<li><a class="reference internal" href="#">HTML theme development</a><ul>
<li><a class="reference internal" href="#creating-themes">Creating themes</a></li>
<li><a class="reference internal" href="#distribute-your-theme-as-a-python-package">Distribute your theme as a Python package</a></li>
<li><a class="reference internal" href="#templating">Templating</a><ul>
<li><a class="reference internal" href="#static-templates">Static templates</a></li>
<li><a class="reference internal" href="#use-custom-page-metadata-in-html-templates">Use custom page metadata in HTML templates</a></li>
<li><a class="reference internal" href="#defining-custom-template-functions">Defining custom template functions</a></li>
<li><a class="reference internal" href="#add-your-own-static-files-to-the-build-assets">Add your own static files to the build assets</a></li>
<li><a class="reference internal" href="#inject-javascript-based-on-user-configuration">Inject JavaScript based on user configuration</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="sphinxsidebar-navigation__pages">
<h3>Site navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Get started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../usage/quickstart.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usage/installation.html">Installing Sphinx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorial/index.html">Tutorial: Build your first project</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User Guides</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../usage/index.html">Using Sphinx</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Extending Sphinx</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="overview.html">Developing extensions overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorials/index.html">Extension tutorials</a></li>
<li class="toctree-l2"><a class="reference internal" href="builders.html">Configuring builders</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">HTML theme development</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../templating.html">Templating</a></li>
<li class="toctree-l1"><a class="reference internal" href="../latex.html">LaTeX customization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../extdev/index.html">Developing extensions for Sphinx</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Community</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../support.html">Get support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../internals/index.html">Contribute to Sphinx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html">Sphinx FAQ</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../man/index.html">Command-Line Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changes.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples.html">Projects using Sphinx</a></li>
</ul>
</div>
</div>
<div class="body" role="main">
<section id="html-theme-development">
<h1>HTML theme development<a class="headerlink" href="#html-theme-development" title="Permalink to this heading">¶</a></h1>
<div class="versionadded">
<p><span class="versionmodified added">New in version 0.6.</span></p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This document provides information about creating your own theme. If you
simply wish to use a pre-existing HTML themes, refer to
<a class="reference internal" href="../usage/theming.html"><span class="doc">HTML Theming</span></a>.</p>
</div>
<p>Sphinx supports changing the appearance of its HTML output via <em>themes</em>.  A
theme is a collection of HTML templates, stylesheet(s) and other static files.
Additionally, it has a configuration file which specifies from which theme to
inherit, which highlighting style to use, and what options exist for customizing
the theme’s look and feel.</p>
<p>Themes are meant to be project-unaware, so they can be used for different
projects without change.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>See <a class="reference internal" href="../extdev/index.html#dev-extensions"><span class="std std-ref">Developing extensions for Sphinx</span></a> for more information that may
be helpful in developing themes.</p>
</div>
<section id="creating-themes">
<h2>Creating themes<a class="headerlink" href="#creating-themes" title="Permalink to this heading">¶</a></h2>
<p>Themes take the form of either a directory or a zipfile (whose name is the
theme name), containing the following:</p>
<ul class="simple">
<li><p>A <code class="file docutils literal notranslate"><span class="pre">theme.conf</span></code> file.</p></li>
<li><p>HTML templates, if needed.</p></li>
<li><p>A <code class="docutils literal notranslate"><span class="pre">static/</span></code> directory containing any static files that will be copied to the
output static directory on build.  These can be images, styles, script files.</p></li>
</ul>
<p>The <code class="file docutils literal notranslate"><span class="pre">theme.conf</span></code> file is in INI format <a class="footnote-reference brackets" href="#id2" id="id1">1</a> (readable by the standard
Python <code class="xref py py-mod docutils literal notranslate"><span class="pre">ConfigParser</span></code> module) and has the following structure:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[theme]</span><span class="w"></span>
<span class="na">inherit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">base theme</span><span class="w"></span>
<span class="na">stylesheet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">main CSS name</span><span class="w"></span>
<span class="na">pygments_style</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">stylename</span><span class="w"></span>
<span class="na">sidebars</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">localtoc.html, relations.html, sourcelink.html, searchbox.html</span><span class="w"></span>

<span class="k">[options]</span><span class="w"></span>
<span class="na">variable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">default value</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p>The <strong>inherit</strong> setting gives the name of a “base theme”, or <code class="docutils literal notranslate"><span class="pre">none</span></code>.  The
base theme will be used to locate missing templates (most themes will not have
to supply most templates if they use <code class="docutils literal notranslate"><span class="pre">basic</span></code> as the base theme), its options
will be inherited, and all of its static files will be used as well. If you
want to also inherit the stylesheet, include it via CSS’ <code class="docutils literal notranslate"><span class="pre">@import</span></code> in your
own.</p></li>
<li><p>The <strong>stylesheet</strong> setting gives a list of CSS filenames separated commas which
will be referenced in the HTML header.  You can also use CSS’ <code class="docutils literal notranslate"><span class="pre">@import</span></code>
technique to include one from the other, or use a custom HTML template that
adds <code class="docutils literal notranslate"><span class="pre">&lt;link</span> <span class="pre">rel="stylesheet"&gt;</span></code> tags as necessary.  Setting the
<a class="reference internal" href="../usage/configuration.html#confval-html_style"><code class="xref std std-confval docutils literal notranslate"><span class="pre">html_style</span></code></a> config value will override this setting.</p></li>
<li><p>The <strong>pygments_style</strong> setting gives the name of a Pygments style to use for
highlighting.  This can be overridden by the user in the
<a class="reference internal" href="../usage/configuration.html#confval-pygments_style"><code class="xref std std-confval docutils literal notranslate"><span class="pre">pygments_style</span></code></a> config value.</p></li>
<li><p>The <strong>pygments_dark_style</strong> setting gives the name of a Pygments style to use
for highlighting when the CSS media query <code class="docutils literal notranslate"><span class="pre">(prefers-color-scheme:</span> <span class="pre">dark)</span></code>
evaluates to true. It is injected into the page using
<code class="xref py py-meth docutils literal notranslate"><span class="pre">add_css_file()</span></code>.</p></li>
<li><p>The <strong>sidebars</strong> setting gives the comma separated list of sidebar templates
for constructing sidebars.  This can be overridden by the user in the
<a class="reference internal" href="../usage/configuration.html#confval-html_sidebars"><code class="xref std std-confval docutils literal notranslate"><span class="pre">html_sidebars</span></code></a> config value.</p></li>
<li><p>The <strong>options</strong> section contains pairs of variable names and default values.
These options can be overridden by the user in <a class="reference internal" href="../usage/configuration.html#confval-html_theme_options"><code class="xref std std-confval docutils literal notranslate"><span class="pre">html_theme_options</span></code></a>
and are accessible from all templates as <code class="docutils literal notranslate"><span class="pre">theme_&lt;name&gt;</span></code>.</p></li>
</ul>
<div class="versionadded">
<p><span class="versionmodified added">New in version 1.7: </span>sidebar settings</p>
</div>
<div class="versionchanged">
<p><span class="versionmodified changed">Changed in version 5.1: </span>The stylesheet setting accepts multiple CSS filenames</p>
</div>
</section>
<section id="distribute-your-theme-as-a-python-package">
<span id="distribute-your-theme"></span><h2>Distribute your theme as a Python package<a class="headerlink" href="#distribute-your-theme-as-a-python-package" title="Permalink to this heading">¶</a></h2>
<p>As a way to distribute your theme, you can use a Python package.  This makes it
easier for users to set up your theme.</p>
<p>To distribute your theme as a Python package, please define an entry point
called <code class="docutils literal notranslate"><span class="pre">sphinx.html_themes</span></code> in your <code class="docutils literal notranslate"><span class="pre">setup.py</span></code> file, and write a <code class="docutils literal notranslate"><span class="pre">setup()</span></code>
function to register your themes using <code class="docutils literal notranslate"><span class="pre">add_html_theme()</span></code> API in it:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 'setup.py'</span>
<span class="n">setup</span><span class="p">(</span>
    <span class="o">...</span>
    <span class="n">entry_points</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">'sphinx.html_themes'</span><span class="p">:</span> <span class="p">[</span>
            <span class="s1">'name_of_theme = your_package'</span><span class="p">,</span>
        <span class="p">]</span>
    <span class="p">},</span>
    <span class="o">...</span>
<span class="p">)</span>

<span class="c1"># 'your_package.py'</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">path</span>

<span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
    <span class="n">app</span><span class="o">.</span><span class="n">add_html_theme</span><span class="p">(</span><span class="s1">'name_of_theme'</span><span class="p">,</span> <span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)))</span>
</pre></div>
</div>
<p>If your theme package contains two or more themes, please call
<code class="docutils literal notranslate"><span class="pre">add_html_theme()</span></code> twice or more.</p>
<div class="versionadded">
<p><span class="versionmodified added">New in version 1.2: </span>‘sphinx_themes’ entry_points feature.</p>
</div>
<div class="deprecated">
<p><span class="versionmodified deprecated">Deprecated since version 1.6: </span><code class="docutils literal notranslate"><span class="pre">sphinx_themes</span></code> entry_points has been deprecated.</p>
</div>
<div class="versionadded">
<p><span class="versionmodified added">New in version 1.6: </span><code class="docutils literal notranslate"><span class="pre">sphinx.html_themes</span></code> entry_points feature.</p>
</div>
</section>
<section id="templating">
<h2>Templating<a class="headerlink" href="#templating" title="Permalink to this heading">¶</a></h2>
<p>The <a class="reference internal" href="../templating.html"><span class="doc">guide to templating</span></a> is helpful if you want to write your
own templates.  What is important to keep in mind is the order in which Sphinx
searches for templates:</p>
<ul class="simple">
<li><p>First, in the user’s <code class="docutils literal notranslate"><span class="pre">templates_path</span></code> directories.</p></li>
<li><p>Then, in the selected theme.</p></li>
<li><p>Then, in its base theme, its base’s base theme, etc.</p></li>
</ul>
<p>When extending a template in the base theme with the same name, use the theme
name as an explicit directory: <code class="docutils literal notranslate"><span class="pre">{%</span> <span class="pre">extends</span> <span class="pre">"basic/layout.html"</span> <span class="pre">%}</span></code>.  From a
user <code class="docutils literal notranslate"><span class="pre">templates_path</span></code> template, you can still use the “exclamation mark”
syntax as described in the templating document.</p>
<section id="static-templates">
<span id="theming-static-templates"></span><h3>Static templates<a class="headerlink" href="#static-templates" title="Permalink to this heading">¶</a></h3>
<p>Since theme options are meant for the user to configure a theme more easily,
without having to write a custom stylesheet, it is necessary to be able to
template static files as well as HTML files.  Therefore, Sphinx supports
so-called “static templates”, like this:</p>
<p>If the name of a file in the <code class="docutils literal notranslate"><span class="pre">static/</span></code> directory of a theme (or in the user’s
static path, for that matter) ends with <code class="docutils literal notranslate"><span class="pre">_t</span></code>, it will be processed by the
template engine.  The <code class="docutils literal notranslate"><span class="pre">_t</span></code> will be left from the final file name.  For
example, the <em>classic</em> theme has a file <code class="docutils literal notranslate"><span class="pre">static/classic.css_t</span></code> which uses
templating to put the color options into the stylesheet.  When a documentation
is built with the classic theme, the output directory will contain a
<code class="docutils literal notranslate"><span class="pre">_static/classic.css</span></code> file where all template tags have been processed.</p>
</section>
<section id="use-custom-page-metadata-in-html-templates">
<h3>Use custom page metadata in HTML templates<a class="headerlink" href="#use-custom-page-metadata-in-html-templates" title="Permalink to this heading">¶</a></h3>
<p>Any key / value pairs in <a class="reference internal" href="../usage/restructuredtext/field-lists.html"><span class="doc">field lists</span></a>
that are placed <em>before</em> the page’s title will be available to the Jinja
template when building the page within the <a class="reference internal" href="../templating.html#meta" title="meta"><code class="xref py py-data docutils literal notranslate"><span class="pre">meta</span></code></a> attribute. For example,
if a page had the following text before its first title:</p>
<div class="highlight-rst notranslate"><div class="highlight"><pre><span></span><span class="nc">:mykey:</span> My value

<span class="gh">My first title</span>
<span class="gh">--------------</span>
</pre></div>
</div>
<p>Then it could be accessed within a Jinja template like so:</p>
<div class="highlight-jinja notranslate"><div class="highlight"><pre><span></span><span class="cp">{%</span>- <span class="k">if</span> <span class="nv">meta</span> <span class="k">is</span> <span class="nf">mapping</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">    </span><span class="cp">{{</span> <span class="nv">meta.get</span><span class="o">(</span><span class="s2">"mykey"</span><span class="o">)</span> <span class="cp">}}</span><span class="x"></span>
<span class="cp">{%</span>- <span class="k">endif</span> <span class="cp">%}</span><span class="x"></span>
</pre></div>
</div>
<p>Note the check that <code class="docutils literal notranslate"><span class="pre">meta</span></code> is a dictionary (“mapping” in Jinja
terminology) to ensure that using it in this way is valid.</p>
</section>
<section id="defining-custom-template-functions">
<h3>Defining custom template functions<a class="headerlink" href="#defining-custom-template-functions" title="Permalink to this heading">¶</a></h3>
<p>Sometimes it is useful to define your own function in Python that you wish to
then use in a template. For example, if you’d like to insert a template value
with logic that depends on the user’s configuration in the project, or if you’d
like to include non-trivial checks and provide friendly error messages for
incorrect configuration in the template.</p>
<p>To define your own template function, you’ll need to define two functions
inside your module:</p>
<ul class="simple">
<li><p>A <strong>page context event handler</strong> (or <strong>registration</strong>) function. This is
connected to the <a class="reference internal" href="../extdev/appapi.html#sphinx.application.Sphinx" title="sphinx.application.Sphinx"><code class="xref py py-class docutils literal notranslate"><span class="pre">Sphinx</span></code></a> application via an event callback.</p></li>
<li><p>A <strong>template function</strong> that you will use in your Jinja template.</p></li>
</ul>
<p>First, define the registration function, which accepts the arguments for
<a class="reference internal" href="../extdev/appapi.html#event-html-page-context"><code class="xref std std-event docutils literal notranslate"><span class="pre">html-page-context</span></code></a>.</p>
<p>Within the registration function, define the template function that you’d like to
use within Jinja. The template function should return a string or Python objects
(lists, dictionaries) with strings inside that Jinja uses in the templating process</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The template function will have access to all of the variables that
are passed to the registration function.</p>
</div>
<p>At the end of the registration function, add the template function to the
Sphinx application’s context with <code class="docutils literal notranslate"><span class="pre">context['template_func']</span> <span class="pre">=</span> <span class="pre">template_func</span></code>.</p>
<p>Finally, in your extension’s <code class="docutils literal notranslate"><span class="pre">setup()</span></code> function, add your registration
function as a callback for <a class="reference internal" href="../extdev/appapi.html#event-html-page-context"><code class="xref std std-event docutils literal notranslate"><span class="pre">html-page-context</span></code></a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># The registration function</span>
 <span class="k">def</span> <span class="nf">setup_my_func</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">pagename</span><span class="p">,</span> <span class="n">templatename</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">doctree</span><span class="p">):</span>
     <span class="c1"># The template function</span>
     <span class="k">def</span> <span class="nf">my_func</span><span class="p">(</span><span class="n">mystring</span><span class="p">):</span>
         <span class="k">return</span> <span class="s2">"Your string is </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">mystring</span>
     <span class="c1"># Add it to the page's context</span>
     <span class="n">context</span><span class="p">[</span><span class="s1">'my_func'</span><span class="p">]</span> <span class="o">=</span> <span class="n">my_func</span>

 <span class="c1"># Your extension's setup function</span>
 <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
     <span class="n">app</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">"html-page-context"</span><span class="p">,</span> <span class="n">setup_my_func</span><span class="p">)</span>
</pre></div>
</div>
<p>Now, you will have access to this function in jinja like so:</p>
<div class="highlight-jinja notranslate"><div class="highlight"><pre><span></span><span class="x">&lt;div&gt;</span>
<span class="cp">{{</span> <span class="nv">my_func</span><span class="o">(</span><span class="s2">"some string"</span><span class="o">)</span> <span class="cp">}}</span><span class="x"></span>
<span class="x">&lt;/div&gt;</span>
</pre></div>
</div>
</section>
<section id="add-your-own-static-files-to-the-build-assets">
<h3>Add your own static files to the build assets<a class="headerlink" href="#add-your-own-static-files-to-the-build-assets" title="Permalink to this heading">¶</a></h3>
<p>By default, Sphinx copies static files on the <code class="docutils literal notranslate"><span class="pre">static/</span></code> directory of the template
directory.  However, if your package needs to place static files outside of the
<code class="docutils literal notranslate"><span class="pre">static/</span></code> directory for some reasons, you need to copy them to the <code class="docutils literal notranslate"><span class="pre">_static/</span></code>
directory of HTML outputs manually at the build via an event hook.  Here is an
example of code to accomplish this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">path</span>
<span class="kn">from</span> <span class="nn">sphinx.util.fileutil</span> <span class="kn">import</span> <span class="n">copy_asset_file</span>

<span class="k">def</span> <span class="nf">copy_custom_files</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">exc</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">app</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">format</span> <span class="o">==</span> <span class="s1">'html'</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">exc</span><span class="p">:</span>
        <span class="n">staticdir</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">'_static'</span><span class="p">)</span>
        <span class="n">copy_asset_file</span><span class="p">(</span><span class="s1">'path/to/myextension/_static/myjsfile.js'</span><span class="p">,</span> <span class="n">staticdir</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
    <span class="n">app</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">'build-finished'</span><span class="p">,</span> <span class="n">copy_custom_files</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="inject-javascript-based-on-user-configuration">
<h3>Inject JavaScript based on user configuration<a class="headerlink" href="#inject-javascript-based-on-user-configuration" title="Permalink to this heading">¶</a></h3>
<p>If your extension makes use of JavaScript, it can be useful to allow users
to control its behavior using their Sphinx configuration. However, this can
be difficult to do if your JavaScript comes in the form of a static library
(which will not be built with Jinja).</p>
<p>There are two ways to inject variables into the JavaScript space based on user
configuration.</p>
<p>First, you may append <code class="docutils literal notranslate"><span class="pre">_t</span></code> to the end of any static files included with your
extension. This will cause Sphinx to process these files with the templating
engine, allowing you to embed variables and control behavior.</p>
<p>For example, the following JavaScript structure:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>mymodule/
├── _static
│   └── myjsfile.js_t
└── mymodule.py
</pre></div>
</div>
<p>Will result in the following static file placed in your HTML’s build output:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>_build/
└── html
    └── _static
        └── myjsfile.js
</pre></div>
</div>
<p>See <a class="reference internal" href="#theming-static-templates"><span class="std std-ref">Static templates</span></a> for more information.</p>
<p>Second, you may use the <code class="xref py py-meth docutils literal notranslate"><span class="pre">Sphinx.add_js_file()</span></code> method without pointing it
to a file. Normally, this method is used to insert a new JavaScript file
into your site. However, if you do <em>not</em> pass a file path, but instead pass
a string to the “body” argument, then this text will be inserted as JavaScript
into your site’s head. This allows you to insert variables into your project’s
JavaScript from Python.</p>
<p>For example, the following code will read in a user-configured value and then
insert this value as a JavaScript variable, which your extension’s JavaScript
code may use:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># This function reads in a variable and inserts it into JavaScript</span>
<span class="k">def</span> <span class="nf">add_js_variable</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
    <span class="c1"># This is a configuration that you've specified for users in `conf.py`</span>
    <span class="n">js_variable</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'my_javascript_variable'</span><span class="p">]</span>
    <span class="n">js_text</span> <span class="o">=</span> <span class="s2">"var my_variable = '</span><span class="si">%s</span><span class="s2">';"</span> <span class="o">%</span> <span class="n">js_variable</span>
    <span class="n">app</span><span class="o">.</span><span class="n">add_js_file</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">js_text</span><span class="p">)</span>
<span class="c1"># We connect this function to the step after the builder is initialized</span>
<span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
    <span class="c1"># Tell Sphinx about this configuration variable</span>
    <span class="n">app</span><span class="o">.</span><span class="n">add_config_value</span><span class="p">(</span><span class="s1">'my_javascript_variable'</span><span class="p">)</span>
    <span class="c1"># Run the function after the builder is initialized</span>
    <span class="n">app</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">'builder-inited'</span><span class="p">,</span> <span class="n">add_js_variable</span><span class="p">)</span>
</pre></div>
</div>
<p>As a result, in your theme you can use code that depends on the presence of
this variable. Users can control the variable’s value by defining it in their
<code class="file docutils literal notranslate"><span class="pre">conf.py</span></code> file.</p>
<dl class="footnote brackets">
<dt class="label" id="id2"><span class="brackets"><a class="fn-backref" href="#id1">1</a></span></dt>
<dd><p>It is not an executable Python file, as opposed to <code class="file docutils literal notranslate"><span class="pre">conf.py</span></code>,
because that would pose an unnecessary security risk if themes are
shared.</p>
</dd>
</dl>
</section>
</section>
</section>
</div>
</div>
<div class="footer" role="contentinfo">
  © <a href="../copyright.html">Copyright</a> 2007-2022, the Sphinx developers.
  Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 5.3.0.
</div>
<script>var embed_css = function() {
    Array.from(document.querySelectorAll("link")).forEach( link => {
        if (link.getAttribute('rel') == 'stylesheet') {
            const style = document.createElement("style");
            var href = link.getAttribute('href');
            let [path, get_parameters, anchor] = split_url(href);
            path = normalize_path(path);
            style.innerText = retrieve_file(path);
            link.replaceWith(style);
        };
    });
};


var embed_js = function() {
    Array.from(document.querySelectorAll("script")).forEach( oldScript => {
        const newScript = document.createElement("script");
        Array.from(oldScript.attributes).forEach( attr => {
            newScript.setAttribute(attr.name, attr.value);
        });
        try {
            if (newScript.hasAttribute('src') && is_virtual(newScript.getAttribute('src'))) {
                var src = newScript.getAttribute('src');
                let [path, get_parameters, anchor] = split_url(src);
                path = normalize_path(path);
                var src = retrieve_file(path) + ' //# sourceMap=' + path;
                newScript.appendChild(document.createTextNode(src));
                newScript.removeAttribute('src');
                oldScript.parentNode.replaceChild(newScript, oldScript);
            }
        } catch (e) {
            // Make sure all scripts are loaded
            console.error("Caught error in " + oldScript.getAttribute("src"), e);
        }
    });
};


var split_url = function(url) {
    // Return a list of three elements: path, GET parameters, anchor
    var anchor = url.split('#')[1] || "";
    var get_parameters = url.split('#')[0].split('?')[1] || "";
    var path = url.split('#')[0];
    path = path.split('?')[0];
    let result = [path, get_parameters, anchor];
    // console.log("Split URL", url, result);
    return result;
}


var virtual_click = function(evnt) {
    // Handle GET parameters and anchors
    // console.log("Virtual click", evnt);

    var el = evnt.currentTarget;
    var name = el.tagName.toLowerCase();

    if (name == 'a') {
        var [path, get_parameters, anchor] = split_url(el.getAttribute('href'));
    } else if (name == 'form') {
        var [path, get_parameters, anchor] = split_url(el.getAttribute('action'));
        const formData = new FormData(el);
        get_parameters = new URLSearchParams(formData).toString();
    } else {
        console.error("Invalid element", el);
    }

    path = normalize_path(path);

    window.parent.postMessage({
        action: "virtual_click",
        argument: {
            path: path,
            get_parameters: get_parameters,
            anchor: anchor,
        }
    }, '*');
    evnt.preventDefault();
    evnt.stopPropagation();
    return false;
};

var fix_links = function() {
    Array.from(document.querySelectorAll("a")).forEach( a => {
        fix_link(a);
    });
};

var fix_link = function(a) {
    if (is_virtual(a.getAttribute('href'))) {
        a.addEventListener('click', virtual_click);
    } else if (a.getAttribute('href').startsWith('#')) {
        a.setAttribute('href', "about:srcdoc" + a.getAttribute('href'))
    } else {
        // External links should open in a new tab. Browsers block links to
        // sites of different origin within an iframe for security reasons.
        a.setAttribute('target', "_blank");
    }
};

var fix_form = function(form) {
    var href = form.getAttribute('action');
    if (is_virtual(href) && form.getAttribute('method').toLowerCase() == 'get') {
        form.addEventListener('submit', virtual_click);
    }
};


var fix_forms = function() {
    Array.from(document.querySelectorAll("form")).forEach( form => {
        fix_form(form);
    });
};


var embed_img = function(img) {
    if (img.hasAttribute('src')) {
        const src = img.getAttribute('src');
        if (is_virtual(src)) {
            var path = normalize_path(src);
            const file = retrieve_file(path);
            const mime_type = window.global_context.file_tree[path].mime_type;
            if (mime_type == 'image/svg+xml') {
                img.setAttribute('src', "data:image/svg+xml;charset=utf-8;base64, " + btoa(file));
            } else {
                img.setAttribute('src', `data:${mime_type};base64, ${file}`);
            }
        };
    };
};

var embed_imgs = function() {
    Array.from(document.querySelectorAll("img")).forEach( img => {
        embed_img(img);
    });
};

var is_virtual = function(url) {
    // Return true if the url should be retrieved from the virtual file tree
    var _url = url.toString().toLowerCase();
    return (! (
        _url == "" ||
        _url[0] == "#" ||
        _url.startsWith('https://') ||
        _url.startsWith('http://') ||
        _url.startsWith('data:') ||
        _url.startsWith('blob:')
    ));
};

var retrieve_file = function(path) {
    // console.log("Retrieving file: " + path);
    var file_tree = window.global_context.file_tree;
    var file = file_tree[path];
    if (!file) {
        console.warn("File not found: " + path);
        return "";
    } else {
        return file.data;
    }
};

var normalize_path = function(path) {
    // make relative paths absolute in context of our virtual file tree

    while (path && path[0] == '/') {
        path = path.substr(1);
    }

    var result = window.global_context.current_path;
    result = result.split('/');
    result.pop();
    result = result.concat(path.split('/'));

    // resolve relative directories
    var array = [];
    Array.from(result).forEach( component => {
        if (component == '..') {
            if (array) {
                array.pop();
            }
        } else if (component == '.') {
        } else {
            if (component) { array.push(component); }
        }
    });

    result = array.join('/');
    // console.log(`Normalized path: ${path} -> ${result} (@${window.global_context.current_path})`);
    return result;
};


var fix_document = function() {
    embed_js(); // This might change the DOM, so do this first
    monkey_patch();
    embed_css();
    embed_imgs();
    fix_links();
    fix_forms();
};


var on_set_data = function(argument) {
    window.global_context = argument;
    console.log("Received data from parent", window.global_context);
    // dynamically fix elements on this page
    try {
        fix_document();
        // Trigger DOMContentLoaded again, some scripts that have just
        // been executed expect it.
        window.document.dispatchEvent(new Event("DOMContentLoaded", {
            bubbles: true,
            cancelable: true
        }));
    } finally {
        observer.observe(window.document.body, {subtree: true, childList: true});
        window.parent.postMessage({
            action: "show_iframe",
            argument: "",
        }, '*');
    }
}


var on_scroll_to_anchor = function(argument) {
    if (window.global_context.anchor) {
        document.location.replace("about:srcdoc#" + window.global_context.anchor);
    }
}


const observer = new MutationObserver((mutationList) => {
    // console.log("Fix mutated elements...", mutationList);
    mutationList.forEach((mutation) => {
        if (mutation.type == 'childList') {
            Array.from(mutation.target.querySelectorAll("a")).forEach( a => {
                fix_link(a);
            });
            Array.from(mutation.target.querySelectorAll("img")).forEach( img => {
                embed_img(img);
            });
            Array.from(mutation.target.querySelectorAll("form")).forEach( form => {
                fix_form(form);
            });
        }
    });
});


var monkey_patch = function() {
    if (typeof jQuery === 'undefined') {return;} // Only for jQuery at the moment
    /**
     * Monkey patch getQueryParameters
     * This function is defined in Sphinx' (v4) doctools.js and incompatible with our
     * approach.
     * This is a copy with effectively only the third line changed.
     * See: https://github.com/sphinx-doc/sphinx/blob/2329fdef8c20c6c75194f5d842b8f62ebad5c79d/sphinx/themes/basic/static/doctools.js#L54
     */
    jQuery._getQueryParameters = jQuery.getQueryParameters;
    jQuery.getQueryParameters = function(s) {
      if (typeof s === 'undefined')
        s = '?' + window.global_context.get_parameters;
      return jQuery._getQueryParameters(s);
    };

    /**
     * Monkey patch jQuery.ajax
     * Only settings.url and settings.complete are supported for virtual
     * URLs.
     */
    jQuery._ajax = jQuery.ajax;
    jQuery.ajax = function(settings) {
        url = normalize_path(settings.url);
        if (is_virtual(url)) {
            var result;
            var data;
            data = retrieve_file(url);
            result = settings.complete({responseText: data}, "");
            return; // Return value not actually needed in searchtools.js
        } else {
            return jQuery.ajax(settings);
        };
    };
}


var on_load = function() {
    // Set up message listener
    window.addEventListener("message", (evnt) => {
        console.log("Received message in iframe", evnt);
        if (evnt.data.action == 'set_data') {
            on_set_data(evnt.data.argument);
        } else if (evnt.data.action == 'scroll_to_anchor') {
            on_scroll_to_anchor(evnt.data.argument);
        }
    }, false);

    // Set parent window title and trigger data transmission
    var favicon = window.document.querySelector("link[rel*='icon']");
    if (favicon) { favicon = favicon.getAttribute('href'); }
    var title = window.document.querySelector('head>title');
    if (title) { title = title.innerText; }

    window.parent.postMessage({
        action: "set_title",
        argument: {
            title: title,
            favicon: favicon
        }
    }, '*');

};


window.addEventListener('load', on_load);
//# sourceURL=inject_post.js</script></body>
</html>